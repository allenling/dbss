dbss
====

**Whysos.info source** 
**环境: Centos6.4+uwsgi+nginx+django-1.5.4**


----------


####2014.6.13 更新索引策略
haystack中更新操作需要手动，每有一个新对象创建，就必须更新一次，才能搜索到，则可以指定新对象被创建的个数大道一定的数字，才一次性更新索引，考虑到在一定时间内，新对象被创建的个数不满足指定的数字，这样不会更新索引，会搜索不到，则可以使用一个进程去每隔一定的时间去查看是否有新对象被创建，有则触发更新索引操作。操作在django_rq中异步进行

模仿redis的快照持久化，在一定时间内有一定个数的键值被改变，则持久化的策略，具体有下面的说明：


更新操作交给django_rq的队列A，操作函数为haystack内置的更新索引函数update\_index

1.在View中，每有一个新对象创建，则在redis的计数器a加1，当有x个新的对象创建的时候，即a=x，并且在队列A中没有等待更新的操作，即A.count < 0，则向队列A加入一个操作，A.enqueue(B)，同时重置计数器a，a=0。

2.使用command，生成一个守护进程，每隔y秒去查看redis中的计数器a否是大于0，并且在队列A中没有等待更新的操作，即A.count <
0，则，在向队列加入一个操作，A.enqueue(B)，同时重置计数器a，a=0。

在A中，至多有一个保留有一个操作，这是因为正在执行的索引更新作没完成，并且由一个更新操作在等待执行，则没必要在将另一个新的更新操作加入了，这是因为当等待的那个更新操作执行的时候，会更新所有的，未更新的索引。
